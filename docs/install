#!/usr/bin/env bash
set -euo pipefail

# Ludolph installer
# Usage: curl -sSL https://ludolph.dev/install | bash

REPO="evannagle/ludolph"
INSTALL_DIR="$HOME/.ludolph/bin"

echo "Installing Ludolph..."
echo

# Detect OS and architecture
OS="$(uname -s | tr '[:upper:]' '[:lower:]')"
ARCH="$(uname -m)"

case "$ARCH" in
    x86_64) ARCH="x86_64" ;;
    aarch64|arm64) ARCH="aarch64" ;;
    *) echo "Unsupported architecture: $ARCH"; exit 1 ;;
esac

case "$OS" in
    linux) TARGET="${ARCH}-unknown-linux-gnu" ;;
    darwin) TARGET="${ARCH}-apple-darwin" ;;
    *) echo "Unsupported OS: $OS"; exit 1 ;;
esac

# Get latest release
LATEST=$(curl -sSL "https://api.github.com/repos/$REPO/releases/latest" | grep '"tag_name"' | cut -d'"' -f4)
if [ -z "$LATEST" ]; then
    echo "No release found. Build from source:"
    echo "  cargo install --git https://github.com/$REPO"
    exit 1
fi

echo "Detected: $OS $ARCH"
echo "Version: $LATEST"
echo

# Create install directory
mkdir -p "$INSTALL_DIR"

# Download binary
DOWNLOAD_URL="https://github.com/$REPO/releases/download/$LATEST/lu-$TARGET"
echo "Downloading..."

if ! curl -sSL "$DOWNLOAD_URL" -o "$INSTALL_DIR/lu"; then
    echo "Download failed."
    echo "Build from source: cargo install --git https://github.com/$REPO"
    exit 1
fi

chmod +x "$INSTALL_DIR/lu"

# Add to PATH
SHELL_RC=""
if [ -f "$HOME/.zshrc" ]; then
    SHELL_RC="$HOME/.zshrc"
elif [ -f "$HOME/.bashrc" ]; then
    SHELL_RC="$HOME/.bashrc"
fi

if [ -n "$SHELL_RC" ]; then
    if ! grep -q '.ludolph/bin' "$SHELL_RC" 2>/dev/null; then
        echo 'export PATH="$HOME/.ludolph/bin:$PATH"' >> "$SHELL_RC"
    fi
fi

export PATH="$INSTALL_DIR:$PATH"

echo "Installed to $INSTALL_DIR/lu"
echo

# Run setup wizard
exec "$INSTALL_DIR/lu" setup
